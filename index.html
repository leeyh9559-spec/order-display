<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>深夜工坊 - 取餐系统</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --green: #004529; --yellow: #F7D08A; }
        body { background: var(--green); color: var(--yellow); font-family: sans-serif; margin: 0; overflow: hidden; }

        /* 启动激活层 */
        #activation-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--green); z-index: 999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer;
        }
        .btn-start { font-size: 3rem; padding: 20px 60px; background: var(--yellow); color: var(--green); border-radius: 50px; font-weight: bold; border:none; }

        /* TV 界面布局 */
        #tv-view { display: none; height: 100vh; flex-direction: column; padding: 20px; box-sizing: border-box; }
        .header { font-size: 3vw; border-bottom: 5px double var(--yellow); padding: 10px 0; text-align: center; margin-bottom: 20px; }
        .main-content { display: flex; flex: 1; gap: 20px; overflow: hidden; }
        
        /* 左侧：大号显示 */
        .big-display { flex: 2; border: 3px solid var(--yellow); border-radius: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        .big-num { font-size: 25vw; font-weight: 900; line-height: 1; }
        
        /* 右侧：队列列表 */
        .side-list { flex: 1; border: 3px solid var(--yellow); border-radius: 20px; display: flex; flex-direction: column; background: rgba(255,255,255,0.05); }
        .list-title { background: var(--yellow); color: var(--green); font-size: 2vw; padding: 10px; text-align: center; font-weight: bold; }
        #queue-items { list-style: none; padding: 0; margin: 0; flex: 1; display: flex; flex-direction: column; }
        .item { font-size: 4vw; padding: 15px; border-bottom: 1px solid rgba(247,208,138,0.2); text-align: center; font-weight: bold; animation: fadeIn 0.5s; }

        @keyframes fadeIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }

        /* 柜台端样式 */
        #counter-view { display: none; padding: 40px; text-align: center; }
        input { font-size: 3rem; padding: 15px; width: 80%; border: 3px solid var(--yellow); background: none; color: white; border-radius: 15px; text-align: center; margin-bottom: 20px; }
        button { font-size: 2.5rem; padding: 20px 60px; background: var(--yellow); color: var(--green); border: none; border-radius: 15px; font-weight: bold; }
    </style>
</head>
<body>

    <div id="activation-overlay" onclick="startSystem()">
        <button class="btn-start">点击开启系统</button>
        <p style="margin-top: 20px; font-size: 1.5rem;">或按遥控器 OK 键</p>
    </div>

    <div id="tv-view">
        <div class="header">MIDNIGHT WORKSHOP 深夜工坊</div>
        <div class="main-content">
            <div class="big-display">
                <div style="font-size: 2vw; opacity: 0.7;">NOW SERVING / 请取餐</div>
                <div id="current-num" class="big-num">---</div>
            </div>
            <div class="side-list">
                <div class="list-title">PICKUP LIST / 取餐列表</div>
                <div id="queue-items"></div>
            </div>
        </div>
    </div>

    <div id="counter-view">
        <h1 style="font-size: 3rem;">柜台控制台</h1>
        <input type="text" id="orderInput" placeholder="输入单号" autofocus>
        <br>
        <button onclick="postOrder()">叫号</button>
    </div>

    <audio id="audio-player" style="display:none;"></audio>

<script>
    const CONFIG = {
        url: 'https://enswbpmkycasjnqfqwli.supabase.co',
        key: 'sb_publishable_5Do4Ho_qHom0i85Eata37w_ikebjM57'
    };
    const supabaseClient = supabase.createClient(CONFIG.url, CONFIG.key);
    
    const urlParams = new URLSearchParams(window.location.search);
    const mode = urlParams.get('view');
    let isUnlocked = false;
    let localQueue = []; // 存储格式：{ num: 'A1', time: Date.now() }

    // 初始化页面
    if (mode === 'tv') {
        document.getElementById('tv-view').style.display = 'flex';
        loadHistory(); // 加载历史数据
        startListening(); // 开启实时监听
        setInterval(cleanOldOrders, 1000); // 每一秒检查一次是否到期
    } else {
        document.getElementById('activation-overlay').style.display = 'none';
        document.getElementById('counter-view').style.display = 'block';
    }

    // 1. 加载最近 10 条记录
    async function loadHistory() {
        const { data, error } = await supabaseClient
            .from('orders')
            .select('order_number, created_at')
            .order('created_at', { ascending: false })
            .limit(10);
        
        if (data) {
            const tenMinutesAgo = Date.now() - (10 * 60 * 1000);
            localQueue = data
                .filter(item => new Date(item.created_at).getTime() > tenMinutesAgo)
                .map(item => ({ 
                    num: item.order_number, 
                    time: new Date(item.created_at).getTime() 
                }));
            updateUI();
        }
    }

    // 2. 实时监听新订单
    function startListening() {
        supabaseClient.channel('any').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'orders' }, payload => {
            const newNum = payload.new.order_number;
            // 加入队列
            localQueue.unshift({ num: newNum, time: Date.now() });
            if (localQueue.length > 10) localQueue.pop();
            
            updateUI();
            if (isUnlocked) playVoice(newNum);
        }).subscribe();
    }

    // 3. 更新界面
    function updateUI() {
        const list = document.getElementById('queue-items');
        const bigDisplay = document.getElementById('current-num');
        
        list.innerHTML = '';
        localQueue.forEach(item => {
            const el = document.createElement('div');
            el.className = 'item';
            el.innerText = item.num;
            list.appendChild(el);
        });

        bigDisplay.innerText = localQueue.length > 0 ? localQueue[0].num : '---';
    }

    // 4. 清理超过 10 分钟的号码
    function cleanOldOrders() {
        const now = Date.now();
        const expireTime = 10 * 60 * 1000;
        const filtered = localQueue.filter(item => (now - item.time) < expireTime);
        
        if (filtered.length !== localQueue.length) {
            localQueue = filtered;
            updateUI();
        }
    }

    // 5. 激活声音
    function startSystem() {
        isUnlocked = true;
        document.getElementById('activation-overlay').style.display = 'none';
        playVoice("ok"); // 测试音
    }

    window.addEventListener('keydown', e => { if (e.keyCode === 13) startSystem(); });

    // 6. 语音播放 (百度 TTS 接口，最兼容电视)
    function playVoice(text) {
        const formatted = text.split('').join(' ');
        const url = `https://tts.baidu.com/text2audio?lan=en&ie=UTF-8&text=Order+${formatted}+is+ready`;
        const player = document.getElementById('audio-player');
        player.src = url;
        player.play().catch(e => console.log("Audio Error:", e));
    }

    // 柜台端发送
    async function postOrder() {
        const input = document.getElementById('orderInput');
        const num = input.value.trim().toUpperCase();
        if (!num) return;
        await supabaseClient.from('orders').insert([{ order_number: num }]);
        input.value = '';
        input.focus();
    }
</script>
</body>
</html>
