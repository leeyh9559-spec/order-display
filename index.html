<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>深夜工坊 - 取餐系统</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --green: #004529; --yellow: #F7D08A; }
        body { background: var(--green); color: var(--yellow); font-family: sans-serif; margin: 0; text-align: center; }
        
        /* 电视模式样式 */
        #tv-view { display: none; height: 100vh; flex-direction: column; }
        .number-display { font-size: 15vw; font-weight: 900; margin-top: 50px; }
        
        /* 柜台模式样式 */
        #counter-view { display: none; padding: 50px; }
        input { font-size: 2rem; padding: 10px; width: 200px; border: 2px solid var(--yellow); background: none; color: white; }
        button { font-size: 2rem; padding: 10px 30px; background: var(--yellow); color: var(--green); border: none; cursor: pointer; }
    </style>
</head>
<body>

    <div id="tv-view">
        <h1 style="border-bottom: 4px double var(--yellow); padding: 20px;">MIDNIGHT WORKSHOP 深夜工坊</h1>
        <div style="font-size: 3rem; margin-top: 40px;">NOW SERVING / 请取餐</div>
        <div id="current-number" class="number-display">---</div>
        <div style="position:fixed; bottom:10px; width:100%; color:rgba(247,208,138,0.3)">点击屏幕开启语音播报</div>
    </div>

    <div id="counter-view">
        <h1>柜台叫号端</h1>
        <input type="text" id="orderInput" placeholder="输入单号">
        <button onclick="sendOrder()">叫号</button>
    </div>

<script>
    const SUPABASE_URL = '你的URL';
    const SUPABASE_KEY = '你的ANON_KEY';
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // 获取 URL 参数确定显示模式
    const urlParams = new URLSearchParams(window.location.search);
    const mode = urlParams.get('view');

    if (mode === 'tv') {
        document.getElementById('tv-view').style.display = 'flex';
        initRealtime();
    } else {
        document.getElementById('counter-view').style.display = 'block';
    }

    // 1. 电视端逻辑：监听数据库
    function initRealtime() {
        supabase
          .channel('any')
          .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'orders' }, payload => {
              const num = payload.new.order_number;
              document.getElementById('current-number').innerText = num;
              speak(num);
          })
          .subscribe();
    }

    // 2. 柜台端逻辑：插入数据
    async function sendOrder() {
        const input = document.getElementById('orderInput');
        if (!input.value) return;
        await supabase.from('orders').insert([{ order_number: input.value.toUpperCase() }]);
        input.value = '';
    }

    // 3. 英文语音播报
    function speak(text) {
        window.speechSynthesis.cancel();
        const msg = new SpeechSynthesisUtterance("Order " + text.split('').join(' ') + " is ready");
        msg.lang = 'en-US';
        msg.rate = 0.8;
        window.speechSynthesis.speak(msg);
    }

    // 点击屏幕解除浏览器静音限制
    document.body.onclick = () => { console.log("Audio Active"); };
</script>
</body>
</html>
