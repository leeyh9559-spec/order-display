<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>深夜工坊 - 取餐系统</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --green: #004529; --yellow: #F7D08A; }
        body { 
            background: var(--green); 
            color: var(--yellow); 
            font-family: 'PingFang SC', sans-serif; 
            margin: 0; 
            overflow: hidden;
        }
        
        /* 电视模式样式 */
        #tv-view { display: none; height: 100vh; flex-direction: column; align-items: center; justify-content: center; }
        .number-display { font-size: 25vw; font-weight: 900; line-height: 1; margin: 20px 0; text-shadow: 5px 5px 0px rgba(0,0,0,0.2); }
        
        /* 柜台模式样式 */
        #counter-view { display: none; padding: 50px; }
        input { 
            font-size: 2rem; padding: 15px; width: 250px; 
            border: 3px solid var(--yellow); background: rgba(255,255,255,0.1); color: white; border-radius: 10px;
        }
        button { 
            font-size: 2rem; padding: 15px 40px; background: var(--yellow); 
            color: var(--green); border: none; cursor: pointer; font-weight: bold; border-radius: 10px; margin-left: 10px;
        }
        .status-dot { width: 15px; height: 15px; background: #44ff44; border-radius: 50%; display: inline-block; margin-right: 5px; }
    </style>
</head>
<body>

    <div id="tv-view">
        <h1 style="border-bottom: 5px double var(--yellow); padding-bottom: 10px; font-size: 3.5rem;">MIDNIGHT WORKSHOP 深夜工坊</h1>
        <div style="font-size: 4rem; letter-spacing: 10px; margin-top: 30px;">NOW SERVING / 请取餐</div>
        <div id="current-number" class="number-display">---</div>
        <div style="position:fixed; bottom:20px; color:rgba(247,208,138,0.4); font-size: 1.2rem;">
            ● 实时连接已就绪 | 点击屏幕开启语音播报
        </div>
    </div>

    <div id="counter-view">
        <h1 style="font-size: 3rem;">柜台叫号控制台</h1>
        <p>输入单号并按回车或点击“叫号”</p>
        <div style="margin-top: 30px;">
            <input type="text" id="orderInput" placeholder="例如: A101" autofocus>
            <button onclick="sendOrder()">叫号</button>
        </div>
        <div id="log" style="margin-top: 50px; color: rgba(255,255,255,0.5);"></div>
    </div>

<script>
    // 修正：将变量名改为 client 以免和库名冲突
    const SUPABASE_URL = 'https://enswbpmkycasjnqfqwli.supabase.co'; 
    const SUPABASE_KEY = 'sb_publishable_5Do4Ho_qHom0i85Eata37w_ikebjM57'; 
    const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const urlParams = new URLSearchParams(window.location.search);
    const mode = urlParams.get('view');

    // 路由控制
    if (mode === 'tv') {
        document.getElementById('tv-view').style.display = 'flex';
        initRealtime();
    } else {
        // 默认显示柜台端
        document.getElementById('counter-view').style.display = 'block';
    }

    // 1. 电视端逻辑：监听插入操作
    function initRealtime() {
        console.log("正在尝试连接实时数据库...");
        client
          .channel('public:orders')
          .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'orders' }, payload => {
              const num = payload.new.order_number;
              document.getElementById('current-number').innerText = num;
              speak(num);
          })
          .subscribe((status) => {
              console.log("实时连接状态:", status);
          });
    }

    // 2. 柜台端逻辑：插入数据
    async function sendOrder() {
        const input = document.getElementById('orderInput');
        const num = input.value.trim().toUpperCase();
        if (!num) return;

        const { error } = await client.from('orders').insert([{ order_number: num }]);
        
        if (error) {
            alert("发送失败: " + error.message);
        } else {
            document.getElementById('log').innerText = "已叫号: " + num;
            input.value = '';
            input.focus();
        }
    }

    // 3. 语音播报
    // --- 修改后的语音逻辑 ---

let isVoiceReady = false;

// 1. 核心点击激活函数
document.body.onclick = () => {
    if (!isVoiceReady) {
        // 在点击的一瞬间，播报一个几乎听不到的短促声音，用来“骗过”浏览器的限制
        const welcome = new SpeechSynthesisUtterance("Voice system online");
        welcome.volume = 0.1; // 音量调低一点，不吵人
        welcome.rate = 1.0;
        welcome.lang = 'en-US';
        
        window.speechSynthesis.speak(welcome);
        
        isVoiceReady = true;
        
        // 视觉反馈：改变提示字样
        const tip = document.querySelector('#tv-view div:last-child');
        if(tip) tip.innerText = "● 语音已激活 (Voice Active)";
        console.log("语音引擎已激活！");
    }
};

// 2. 改进后的播报函数
function speak(text) {
    if (!isVoiceReady) {
        console.warn("语音尚未激活，请先点击一下屏幕任意位置！");
        return;
    }

    // 先清除所有排队的声音，防止旧号码一直念不完
    window.speechSynthesis.cancel();
    
    // 格式化号码，让念出来更自然，例如 A101 念成 "Order A, 1, 0, 1"
    const charArray = text.split('');
    const formattedText = "Order " + charArray.join(' ') + " is ready";
    
    const msg = new SpeechSynthesisUtterance(formattedText);
    msg.lang = 'en-US';
    msg.rate = 0.8; // 稍微慢一点，更清晰
    msg.pitch = 1.0;
    msg.volume = 1.0;

    window.speechSynthesis.speak(msg);
}
    function speak(text) {
        window.speechSynthesis.cancel();
        const msg = new SpeechSynthesisUtterance("Order " + text.split('').join(' ') + " is ready");
        msg.lang = 'en-US';
        msg.rate = 0.8;
        window.speechSynthesis.speak(msg);
    }

    // 监听回车键
    document.getElementById('orderInput').addEventListener("keypress", (e) => {
        if (e.key === "Enter") sendOrder();
    });

    document.body.onclick = () => { console.log("音频已激活"); };
</script>
</body>
</html>
